<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת דירוג תמונות</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; background: #f0f2f5; margin: 0; padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); max-width: 500px; margin: auto; }
        img { max-width: 100%; border-radius: 10px; margin-bottom: 20px; max-height: 400px; object-fit: contain; }
        .rating-btns { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
        button { padding: 15px; border: none; border-radius: 8px; cursor: pointer; background: #007bff; color: white; font-weight: bold; }
        button:disabled { background: #ccc; }
        .admin-panel { margin-top: 30px; border-top: 2px solid #ccc; padding-top: 20px; }
        .hidden { display: none; }
        #stats { font-size: 1.2rem; font-weight: bold; color: #28a745; }
    </style>
</head>
<body>

<div class="card">
    <h2 id="img-title">טוען תמונה...</h2>
    <img id="main-image" src="" alt="תמונה">
    
    <div id="user-view">
        <p>דרגו את התמונה (1-10):</p>
        <div class="rating-btns" id="rating-area">
            </div>
        <p id="voted-msg" class="hidden">הדירוג נשלח! המתינו לתמונה הבאה...</p>
    </div>

    <div id="admin-view" class="admin-panel hidden">
        <h3>לוח בקרה אדמין</h3>
        <button onclick="prevImage()">⬅️ קודם</button>
        <span id="img-index">1 / 100</span>
        <button onclick="nextImage()">הבא ➡️</button>
        <div id="stats">ממוצע נוכחי: <span id="avg-score">0</span></div>
        <button style="background:red; margin-top:10px;" onclick="showSummary()">הצג תמונה מנצחת</button>
    </div>
</div>

<script>
    // --- הגדרות FIREBASE (החלף בפרטים שלך) ---
    const firebaseConfig = {
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
        databaseURL: "https://YOUR_PROJECT_ID-default-rtdb.firebaseio.com",
        projectId: "YOUR_PROJECT_ID",
        storageBucket: "YOUR_PROJECT_ID.appspot.com",
        messagingSenderId: "YOUR_ID",
        appId: "YOUR_APP_ID"
    };
    
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- הגדרות משחק ---
    const totalImages = 100;
    let isAdmin = window.location.search.includes('admin=true');
    const imgElement = document.getElementById('main-image');
    const indexElement = document.getElementById('img-index');
    const ratingArea = document.getElementById('rating-area');

    if (isAdmin) document.getElementById('admin-view').classList.remove('hidden');

    // יצירת כפתורי דירוג
    for (let i = 1; i <= 10; i++) {
        let btn = document.createElement('button');
        btn.innerText = i;
        btn.onclick = () => submitRating(i);
        ratingArea.appendChild(btn);
    }

    // סנכרון תמונה נוכחית מהשרת
    db.ref('currentImage').on('value', (snapshot) => {
        let idx = snapshot.val() || 1;
        imgElement.src = `images/${idx}.jpg`; // וודא שהתמונות בתיקיית images וממוספרות 1-100
        indexElement.innerText = `${idx} / ${totalImages}`;
        document.getElementById('img-title').innerText = `תמונה ${idx}`;
        resetUI();
        updateStats(idx);
    });

    function submitRating(val) {
        db.ref('currentImage').once('value', (snap) => {
            let idx = snap.val() || 1;
            db.ref(`ratings/${idx}`).push(val);
            document.getElementById('rating-area').classList.add('hidden');
            document.getElementById('voted-msg').classList.remove('hidden');
        });
    }

    function resetUI() {
        document.getElementById('rating-area').classList.remove('hidden');
        document.getElementById('voted-msg').classList.add('hidden');
    }

    function nextImage() {
        db.ref('currentImage').transaction(idx => (idx < totalImages ? idx + 1 : idx));
    }

    function prevImage() {
        db.ref('currentImage').transaction(idx => (idx > 1 ? idx - 1 : idx));
    }

    function updateStats(idx) {
        db.ref(`ratings/${idx}`).on('value', (snap) => {
            let data = snap.val();
            if (data) {
                let scores = Object.values(data);
                let avg = (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(2);
                document.getElementById('avg-score').innerText = avg;
            } else {
                document.getElementById('avg-score').innerText = "0";
            }
        });
    }

    function showSummary() {
        db.ref('ratings').once('value', (snap) => {
            let all = snap.val();
            let winner = {id: 0, avg: 0};
            for (let id in all) {
                let scores = Object.values(all[id]);
                let avg = scores.reduce((a, b) => a + b, 0) / scores.length;
                if (avg > winner.avg) winner = {id, avg};
            }
            alert(`התמונה המנצחת היא מספר ${winner.id} עם ממוצע של ${winner.avg.toFixed(2)}!`);
        });
    }
</script>
</body>
</html>